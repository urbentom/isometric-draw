<html>
    <head>
        <title>Playground! FPS</title>
    </head>
    <body>
        <canvas id="grid" width="700" height="700"></canvas>


    </body>
    <style>
        #grid{
            background-color: thistle;
        }
    </style>
    <script>

        function app (){
            const canvas=document.getElementById("grid");

            const ctx=canvas.getContext("2d");
            const cw=canvas.width;
            const ch=canvas.height;

            const gridSize = 30;
            const halfGridSize = gridSize / 2;

            const shapes = []
            const clickShapes = []

            let moveMousePosition = {
                x: 0,
                y: 0
            }

            let clickMousePosition = undefined;


            let offsetX,offsetY;

            function reOffset(){
                const BB=canvas.getBoundingClientRect();
                offsetX=BB.left;
                offsetY=BB.top;        
            }
            
            
            function initial(){
                
                reOffset();
                ctx.fillStyle='purple';
                ctx.strokeStyle="grey";
                ctx.lineWidth=1;

                // Generate all grid
                for(var x = 0; x < cw; x += gridSize){
                    const xEven = ((x / gridSize)%2 === 0)? true : false;
                    const xPlus = x + gridSize
                
                    for(var y = 0; y < ch; y += halfGridSize){

                        const yEven = ((y / halfGridSize)%2 === 0)? true : false;
                        const yPlus = y + gridSize

                        if(yEven && xEven || !yEven && !xEven){
                            shapes.push({
                                id: `${x}:${y}`,
                                shape: [{x, y: y + halfGridSize}, {x: xPlus, y: yPlus}, {x:xPlus, y}]
                            })
                        }
                        else if(!yEven && xEven || yEven && !xEven){
                            shapes.push({
                                id: `${x}:${y}`,
                                shape: [{x: x, y: yPlus}, {x:x + gridSize, y: y + halfGridSize}, {x: x, y}]
                            })
                        }
                        else {
                            // You done fucked up a-aron
                        }

                    }
                }


            }


            function draw(){
                ctx.clearRect(0,0,cw,ch);
                for(var i=0;i<shapes.length;i++){
                    defineShape(shapes[i].shape);

                    if(clickMousePosition){
                        if(ctx.isPointInPath(clickMousePosition.x, clickMousePosition.y)){
                            console.log('Click!')
                            clickShapes.push(shapes[i]);
                            ctx.fill();
                            clickMousePosition = undefined;
                        }

                    }

                    if(ctx.isPointInPath(moveMousePosition.x, moveMousePosition.y)){
                        ctx.strokeStyle="black";
                        ctx.stroke();
                        ctx.strokeStyle="grey";
                    }else{
                        ctx.stroke()
                    } 
                    
                    if(clickShapes.find( shape => shape.id === shapes[i].id)){
                        ctx.fill();
                    }
                                     
                }
            }

            function loop(){
                window.setTimeout(loop, 20);
                draw() 
            }


            function defineShape(s){
                ctx.beginPath();
                ctx.moveTo(s[0].x,s[0].y);
                for(var i=1;i<s.length;i++){
                    ctx.lineTo(s[i].x,s[i].y);
                }
                ctx.closePath();
            }

            function handleMouseMove(e){
                e.preventDefault();
                e.stopPropagation();

                mouseX=parseInt(e.clientX-offsetX);
                mouseY=parseInt(e.clientY-offsetY);

                moveMousePosition = {
                    x: mouseX,
                    y: mouseY
                }
 
            }

            function handleMouseClick(e){
                e.preventDefault();
                e.stopPropagation();

                mouseX=parseInt(e.clientX-offsetX);
                mouseY=parseInt(e.clientY-offsetY);

                clickMousePosition = {
                    x: mouseX,
                    y: mouseY
                }
            }

            canvas.addEventListener('mousemove', handleMouseMove)
            canvas.addEventListener('click', handleMouseClick)


            initial();
            loop();


        }


        (function(){
            console.log('Start')
            document.addEventListener("DOMContentLoaded", app);
        })();


    </script>
</html>